extends _layout

block append styles
  link(rel="stylesheet", type="text/css", href="styles/pages/news.css")

block title
  title 园区新闻

block content
  pageName = "news"

  include partials/_header.jade

  .container.body
    ul.article-list.list-unstyled.col-md-9
    script(id='categoryNotExist', data-tmpl-html=".article-list", type="text/template").
      <li>没有该新闻分类</li>
    script(id="articleList", data-tmpl-html=".article-list", type="text/template").
      {{^articles}}该分类下暂时没有新闻{{/articles}}
      {{#articles}}
      <li>
        <article>
          <header>
            <h1 class="article-title">{{name}}</h1>
            <p class="article-meta">
              <time>{{../formatedPublishTime}}</time>
              {{! <a href="{{../linkArticle} }">评论：{{comment_count} }</a> }}
            </p>
          </header>
          {{#renderImage}}
          <section class="article-image">
            <img src="{{image}}" width="670" height="300">
          </section>
          {{/renderImage}}
          <section class="article-intro">
            <p>{{{../cleanFirstParagraph}}}</p>
            <p><a href="{{../linkArticle}}" class="article-more">继续阅读 >></a></p>
          </section>
          <footer class="article-share"></footer>
        </article>
      </li>
      {{/articles}}

    .aside.pull-right.col-md-3
      .aside-module.category-list
        h2.aside-module-heading 新闻分类
        ul.list-unstyled
        script(id="categoryList", data-tmpl-html=".category-list > ul.list-unstyled", type="text/template").
          {{^categories}}<li>暂时没有任何分类</li>{{/categories}}
          {{#categories}}
            <li>
              <a {{#active}}class="active"{{/active}} href="news.html?category={{id}}">{{name}}</a>
            </li>
          {{/categories}}
      .aside-module
        h2.aside-module-heading
          a(href="media_download.html")
            | 媒体资料下载
            i.glyphicon.glyphicon-download

  script(id="fetchListError", type="text/template").
    <li>获取信息失败</li>

  include partials/_footer.jade

block append scripts
  script(src="scripts/momentjs/moment.js")
  script(src="scripts/momentjs/lang/zh-cn.js")
  :coffee

    articlesData =
      formatedPublishTime: -> moment(@publish_at).format 'll'
      cleanFirstParagraph: ->
        $.trim $('<div>').html(@content).find('div, p').first().text()

    preprocessArticles = (articles) ->
      for article in articles
        image = $('<div>').html(article.content).find('img').first().attr 'src'
        if image
          article.renderImage = true
          article.image = image + '!670x300'
        else
          article.renderImage = false
      articles

    renderArticleList = (category) ->
      unless reqconf.newsCategory category
        $tmpl('categoryNotExist').last().addClass 'last'
        return

      $articleContainer = $('.article-list').spin()
      requester.get('/articles', {category}).done (articles) ->
        $articleContainer.spin false
        articlesData.articles = preprocessArticles articles
        $tmpl('articleList', articlesData).last().addClass 'last'
      .fail ->
        $articleContainer.html $('#fetchListError').html()

    matchs = location.search.match /(\?|&)category=(\d+)(&|$)/
    categoryId = if matchs?[2]? then parseInt(matchs[2], 10) else null
    renderArticleList categoryId if categoryId?

    requester.get('/articles/categories').done (categories) ->
      articleRendered = true
      unless categoryId?
        articleRendered = false
        categoryId = categories?[0]?.id

      categories = for category in categories
        continue unless reqconf.newsCategory category.id
        category.active = category.id is categoryId
        category

      $tmpl 'categoryList', {categories}
      return if articleRendered
      renderArticleList categoryId
    .fail ->
      $(".category-list > ul.list-unstyled").html $('#fetchListError').html()

